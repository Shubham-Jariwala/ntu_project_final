<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCID Publication Extractor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .spinner-border {
            display: none;
        }
        .loading .spinner-border {
            display: inline-block;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">ORCID Publication Extractor</h2>
    
    <!-- Status message -->
    {% if cache_info %}
    <div class="alert alert-info mb-3">{{ cache_info }}</div>
    {% endif %}
    
    <!-- Single professor search form -->
    <form method="post" class="mb-4" id="orcidForm">
        <div class="input-group mb-2">
            <input type="text" name="prof_name" class="form-control" placeholder="Enter professor name (e.g. John Doe)" value="{{ prof_name }}" required>
        </div>
        <div class="row g-2 mb-2">
            <div class="col-md-6">
                <label for="start_year" class="form-label">Start Year</label>
                <input type="number" name="start_year" id="start_year" class="form-control" value="2000" min="1900" max="2100" required>
            </div>
            <div class="col-md-6">
                <label for="end_year" class="form-label">End Year</label>
                <input type="number" name="end_year" id="end_year" class="form-control" value="2050" min="1900" max="2100" required>
            </div>
        </div>
        <div class="mt-2">
            <button class="btn btn-primary" type="submit">Extract</button>
            <div class="spinner-border text-primary ms-2" role="status" id="loadingSpinner">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </form>
    <!-- Excel upload form -->
    <form method="post" action="/upload" enctype="multipart/form-data" class="mb-4" id="uploadForm">
                <div class="row g-2 align-items-center">
                        <div class="col-auto">
                                <input type="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                        </div>
                        <div class="col-auto">
                                <input type="text" name="sheet_name" class="form-control" placeholder="Sheet name or index (optional)">
                        </div>
                    <div class="col-auto">
                        <input type="number" name="start_year" class="form-control" placeholder="Start year (optional)" min="1900" max="2100">
                    </div>
                    <div class="col-auto">
                        <input type="number" name="end_year" class="form-control" placeholder="End year (optional)" min="1900" max="2100">
                    </div>
                        <div class="col-auto">
                                <button class="btn btn-success" type="submit" id="uploadBtn">Upload & Generate Excel</button>
                        </div>
                        <div class="col-auto">
                                <button type="button" class="btn btn-info" onclick="printReport()">Print Report</button>
                        </div>
                </div>
                <div id="uploadStatus" class="mt-2" style="display: none;">
                    <div class="alert alert-info d-inline-block">
                        <span id="statusText">Processing...</span>
                    </div>
                </div>
        </form>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
        {% if publications %}
        <div class="mt-3">
            <div id="pubs">
                <!-- Stats (moved here for single-page view) -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Total citations</h5>
                                <p class="display-6">{{ stats.total_citations if stats else 0 }}</p>
                            </div>
                        </div>
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Publications by source</h5>
                                <canvas id="sourcePie" width="200" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Citations by year</h5>
                                <canvas id="yearBar" width="600" height="250"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Top works by citations</h5>
                                <canvas id="worksBar" width="600" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Publications list -->
                {% for cat, pubs in publications.items() %}
                        <div class="mt-4">
                                <h4 class="mb-3 text-primary">{{ cat.capitalize() }}</h4>
                                {% if pubs %}
                                        <div class="table-responsive">
                                                <table class="table table-bordered table-striped align-middle">
                                                        <thead class="table-light">
                                                        <tr>
                                                                {% for col in pubs[0].keys() %}
                                                                        {% if cat == 'journal' %}
                                                                                {% if col == 'Publication Date' %}
                                                                                        {# Skip Publication Date column for journal #}
                                                                                {% elif col == 'Year' %}
                                                                                        <th>Publication Date</th>
                                                                                {% else %}
                                                                                        <th>{{ col }}</th>
                                                                                {% endif %}
                                                                        {% elif cat == 'chapter' and col in ['Article DOI', 'Article Title', 'All Authors', 'Journal Title'] %}
                                                                                {# Skip these columns for chapter #}
                                                                        {% else %}
                                                                                <th>{{ col }}</th>
                                                                        {% endif %}
                                                                {% endfor %}
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {% for pub in pubs %}
                                                                <tr>
                                                                        {% for col, v in pub.items() %}
                                                                                {% if cat == 'journal' %}
                                                                                        {% if col == 'Publication Date' %}
                                                                                                {# Skip Publication Date column for journal #}
                                                                                        {% else %}
                                                                                                <td>{{ v if v and v != 'Not available' else '—' }}</td>
                                                                                        {% endif %}
                                                                                {% elif cat == 'chapter' and col in ['Article DOI', 'Article Title', 'All Authors', 'Journal Title'] %}
                                                                                        {# Skip these columns for chapter #}
                                                                                {% else %}
                                                                                        <td>{{ v if v and v != 'Not available' else '—' }}</td>
                                                                                {% endif %}
                                                                        {% endfor %}
                                                                </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                </table>
                                        </div>
                                {% else %}
                                        <div class="alert alert-warning">No {{ cat }} found for this ORCID in the given years.</div>
                                {% endif %}
                        </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
</div>
<script>
    document.getElementById('orcidForm').addEventListener('submit', function() {
        document.getElementById('loadingSpinner').style.display = 'inline-block';
    });
    
    document.getElementById('uploadForm').addEventListener('submit', function() {
        var statusDiv = document.getElementById('uploadStatus');
        var statusText = document.getElementById('statusText');
        var uploadBtn = document.getElementById('uploadBtn');
        
        statusDiv.style.display = 'block';
        statusText.textContent = 'Processing...';
        uploadBtn.disabled = true;
    });
</script>
{% if stats %}
<script id="stats-data" type="application/json">{{ stats|tojson }}</script>
{% else %}
<script id="stats-data" type="application/json">null</script>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // load stats JSON from a hidden script tag to avoid template parsing issues
    const statsRaw = document.getElementById('stats-data') ? document.getElementById('stats-data').textContent : null;
    let stats = null;
    try {
        stats = statsRaw ? JSON.parse(statsRaw) : null;
    } catch (e) {
        console.error('Failed to parse stats JSON', e);
        stats = null;
    }
    if (stats) {
        // Source distribution pie
        const sourceData = [
            stats.source_counts.ORCID || 0,
            stats.source_counts.CrossRef || 0,
            stats.source_counts.OpenAlex || 0,
            stats.source_counts['Google Scholar'] || 0,
            stats.source_counts.Unknown || 0
        ];
        const sourceLabels = ['ORCID', 'CrossRef', 'OpenAlex', 'Google Scholar', 'Unknown'];
        const sourceCtx = document.getElementById('sourcePie').getContext('2d');
        new Chart(sourceCtx, {
            type: 'pie',
            data: {
                labels: sourceLabels,
                datasets: [{ data: sourceData, backgroundColor: ['#007bff','#28a745','#ffc107','#dc3545','#6c757d'] }]
            }
        });

        // Yearly citations bar
        const years = Object.keys(stats.yearly_citations || {}).sort();
        const yearVals = years.map(y => stats.yearly_citations[y] || 0);
        const yearCtx = document.getElementById('yearBar').getContext('2d');
        new Chart(yearCtx, {
            type: 'bar',
            data: {
                labels: years,
                datasets: [{ label: 'Citations', data: yearVals, backgroundColor: '#007bff' }]
            },
            options: { responsive:true }
        });

        // Top works bar
        const works = stats.top_works || [];
        const workLabels = works.map(w => w[0].length > 30 ? w[0].slice(0,27) + '...' : w[0]);
        const workVals = works.map(w => w[1]);
        const worksCtx = document.getElementById('worksBar').getContext('2d');
        new Chart(worksCtx, {
            type: 'bar',
            data: {
                labels: workLabels,
                datasets: [{ label: 'Citations', data: workVals, backgroundColor: '#17a2b8' }]
            },
            options: { responsive:true, indexAxis: 'y' }
        });
    }
</script>
<script>
    function printReport() {
        // Hide forms and other non-printable elements temporarily
        const forms = document.querySelectorAll('form');
        forms.forEach(form => form.style.display = 'none');
        
        // Print the page
        window.print();
        
        // Restore the forms after printing
        forms.forEach(form => form.style.display = 'block');
    }
</script>
<!-- Add print-specific styles -->
<style media="print">
    /* Hide elements that shouldn't be printed */
    form, .btn, input {
        display: none !important;
    }
    
    /* Ensure charts and tables print well */
    .card {
        break-inside: avoid;
        margin-bottom: 20px;
    }
    
    /* Ensure good spacing and readability */
    .table {
        font-size: 12pt;
    }
    
    /* Force background colors and borders to print */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
</style>
</body>
</html>
